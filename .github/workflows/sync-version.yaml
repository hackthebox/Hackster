name: Sync Version

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  sync-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # Need full history for tag operations

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix if present (v1.9.0 -> 1.9.0)
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$GITHUB_REF_NAME" >> "$GITHUB_OUTPUT"

      - name: Update pyproject.toml
        run: |
          sed -i 's/^version = ".*"/version = "${{ steps.version.outputs.version }}"/' pyproject.toml

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet pyproject.toml; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit, push, and move tag
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit version bump
          git add pyproject.toml
          git commit -m "ðŸ”– Bump version to ${{ steps.version.outputs.version }}"
          git push

          # Move tag to the new commit
          git tag -f ${{ steps.version.outputs.tag }}
          git push --force origin ${{ steps.version.outputs.tag }}
